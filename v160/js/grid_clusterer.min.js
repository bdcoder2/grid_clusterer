class map_tile_overlay{constructor(tile_size){this.maxZoom=22;this.tile_border_color="#008000";this.tile_border_style="dashed";this.tile_border_width="1px";this.tileSize=tile_size}getTile(coord,zoom,owner_doc){let div=owner_doc.createElement("div");div.style.height=this.tileSize.height+"px";div.style.width=this.tileSize.width+"px";div.style.borderColor=this.tile_border_color;div.style.borderStyle=this.tile_border_style;div.style.borderWidth=this.tile_border_width;return div}releaseTile(elem){}set border_color(border_color){if(typeof border_color=="string"){if(border_color.trim().length>0){this.tile_border_color=border_color}}}set border_style(border_style){if(typeof border_style=="string"){if(border_style.trim().length>0){this.tile_border_style=border_style}}}set border_width(border_width){if(typeof border_width=="string"){if(border_width.trim().length>0){this.tile_border_width=border_width}}}}class grid_clusterer{constructor(map,data_points=[],opts){this.k_lat_min=-85.051128;this.k_lat_max=85.051128;this.k_lon_min=-180;this.k_lon_max=180;this.k_google_map_tile_size=256;this.k_pixels_per_lon_degree=this.k_google_map_tile_size/360;this.k_pixels_per_lon_radian=this.k_google_map_tile_size/(2*Math.PI);this.k_pixel_origin=new google.maps.Point(this.k_google_map_tile_size/2,this.k_google_map_tile_size/2);this.k_4_pi=4*Math.PI;this.k_half_pi=Math.PI/2;this.k_degrees_to_radians=Math.PI/180;this.k_tile_height_min=128;this.k_tile_height_max=512;this.k_tile_width_min=this.k_tile_height_min;this.k_tile_width_max=this.k_tile_height_max;this.k_grid_box_height_max=64;this.k_grid_box_width_max=this.k_grid_box_height_max;this.k_cluster_size_min=1;this.k_cluster_size_default=10;this.k_cluster_zoom_max_default=14;this.k_cluster_marker_icon_default={fillColor:"#008000",fillOpacity:.8,path:google.maps.SymbolPath.CIRCLE,scale:31,strokeColor:"#FFFFFF",strokeWeight:2};this.k_cluster_marker_label_default={color:"#FFFFFF",fontFamily:"Arial,sans-serif",fontSize:"9pt",fontWeight:"bold",text:"*"};this.k_grid_point_marker_icon_default={fillColor:"#DB4437",fillOpacity:.8,path:google.maps.SymbolPath.CIRCLE,scale:23,strokeColor:"#FFFFFF",strokeWeight:2};this.k_grid_point_marker_label_default={color:"#FFFFFF",fontFamily:"Arial,sans-serif",fontSize:"9pt",fontWeight:"bold",text:"*"};this.k_tile_border_color_default="#008000";this.k_tile_border_style_default="dashed";this.k_tile_border_width_default="1px";this.map=null;this.tile_overlay=null;this.auto_redraw_map=new Map;this.data_points_map=new Map;this.tiles=new Map;this.configure_use_defaults();if(map){this.map=map}this.configure(opts);this.data_points_upsert(data_points)}cluster_marker_click_handler_add(tile){tile.marker.addListener("click",(event=>{let evt;evt={event:event,tile:tile};if(this.cluster_marker_click_handler){this.cluster_marker_click_handler(evt)}if(this.cluster_marker_click_check){this.cluster_clicked_tile_coord=tile.coord;this.cluster_clicked_zoom_level=tile.zoom;this.cluster_marker_click_check_handler(evt)}if(!this.string_empty(this.cluster_marker_click_event_name)){google.maps.event.trigger(this.map,this.cluster_marker_click_event_name,evt)}}))}cluster_marker_click_check_handler(evt){if(!this.map)return;if(evt.tile){let zoom_level=0;let map_zoom_level=this.map.getZoom();if(this.cluster_clicked_tile_coord){if(this.tile_coord_lookup(this.cluster_clicked_tile_coord)){zoom_level=map_zoom_level+1}else{if(map_zoom_level<=this.cluster_clicked_zoom_level){zoom_level=this.cluster_clicked_zoom_level+1}}}this.cluster_clicked_tile_coord=null;this.cluster_clicked_zoom_level=0;if(zoom_level>0){this.map.setZoom(zoom_level)}}}cluster_marker_click_handler_default(evt){if(!this.map)return;if(evt.tile){this.map.fitBounds(evt.tile.data_bounds)}}cluster_marker_create_default(evt){let marker_opts;marker_opts={map:null,position:evt.tile.bounds.getCenter(),zIndex:google.maps.Marker.MAX_ZINDEX+evt.tile.data_keys.length};if(this.cluster_marker_icon_default){marker_opts.icon=this.cluster_marker_icon_default}if(this.cluster_marker_label_default){let marker_label=this.cluster_marker_label_default;marker_label.text=evt.tile.data_keys.length.toString();marker_opts.label=marker_label;marker_opts.title=marker_label.text}return new google.maps.Marker(marker_opts)}cluster_marker_update_default(evt){if(this.cluster_marker_label_default){if(evt.tile.marker instanceof google.maps.Marker){let marker_label=this.cluster_marker_label_default;marker_label.text=evt.tile.data_keys.length.toString();evt.tile.marker.setLabel(marker_label);evt.tile.marker.setTitle(marker_label.text)}}}configure_use_defaults(){this.tile_coord_min=null;this.tile_coord_max=null;this.cluster_size_min=this.k_cluster_size_default;this.cluster_zoom_max=this.k_cluster_zoom_max_default;this.tile_size=new google.maps.Size(this.k_google_map_tile_size,this.k_google_map_tile_size);this.tile_border_color=this.k_tile_border_color_default;this.tile_border_style=this.k_tile_border_style_default;this.tile_border_width=this.k_tile_border_width_default;this.grid_point_rows=Math.floor(this.tile_size.height/this.k_grid_box_height_max);this.grid_point_cols=Math.floor(this.tile_size.width/this.k_grid_box_width_max);this.grid_box_height=this.tile_size.height/this.grid_point_rows;this.grid_box_width=this.tile_size.width/this.grid_point_cols;this.cluster_marker_click_handler=this.cluster_marker_click_handler_default;this.cluster_marker_create_handler=this.cluster_marker_create_default;this.cluster_marker_update_handler=this.cluster_marker_update_default;this.cluster_marker_icon_default=this.k_cluster_marker_icon_default;this.cluster_marker_label_default=this.k_cluster_marker_label_default;this.grid_point_marker_click_handler=null;this.grid_point_marker_create_handler=this.grid_point_marker_create_default;this.grid_point_marker_update_handler=this.grid_point_marker_update_default;this.grid_point_marker_icon_default=this.k_grid_point_marker_icon_default;this.grid_point_marker_label_default=this.k_grid_point_marker_label_default;this.tiles_redraw_start_event_name=null;this.tiles_redraw_end_event_name=null;this.cluster_marker_click_event_name=null;this.grid_point_marker_click_event_name=null;this.cluster_marker_click_check=true;this.cluster_clicked_tile_coord=null;this.cluster_clicked_zoom_level=0}expand_map_bounds_by_tile_size(){let map_zoom_level;let ne;let sw;let map_bounds;let tile_bounds;let tile_coord;if(!this.map)return null;map_bounds=this.map.getBounds();if(!map_bounds)return null;map_zoom_level=this.map.getZoom();if(map_zoom_level==0){return map_bounds}tile_coord=this.latlon_to_tile_coord(map_bounds.getNorthEast(),map_zoom_level);tile_bounds=this.tile_coord_to_latlon_bounds(tile_coord,map_zoom_level);ne=tile_bounds.getNorthEast();map_bounds.extend(ne);tile_coord=this.latlon_to_tile_coord(map_bounds.getSouthWest(),map_zoom_level);tile_bounds=this.tile_coord_to_latlon_bounds(tile_coord,map_zoom_level);sw=tile_bounds.getSouthWest();map_bounds.extend(sw);return map_bounds}grid_point_delete(grid_pt){if(grid_pt){grid_pt.data_keys.length=0;if(grid_pt.marker){google.maps.event.clearInstanceListeners(grid_pt.marker);if(grid_pt.marker instanceof google.maps.Marker){grid_pt.marker.setMap(null)}else if(grid_pt.marker instanceof google.maps.marker.AdvancedMarkerView){grid_pt.marker.map=null}grid_pt.marker=null}grid_pt.tile=null;grid_pt=null}}grid_point_marker_click_handler_add(grid_pt){if(this.grid_point_marker_click_handler){grid_pt.marker.addListener("click",(event=>{let evt;evt={event:event,grid_point:grid_pt};this.grid_point_marker_click_handler(evt)}))}if(!this.string_empty(this.grid_point_marker_click_event_name)){grid_pt.marker.addListener("click",(event=>{let evt;evt={event:event,grid_point:grid_pt};google.maps.event.trigger(this.map,this.grid_point_marker_click_event_name,evt)}))}}grid_point_marker_create_default(evt){let marker_opts;marker_opts={map:null,position:evt.grid_point.bounds.getCenter(),zIndex:google.maps.Marker.MAX_ZINDEX+evt.grid_point.data_keys.length};if(this.grid_point_marker_icon_default){marker_opts.icon=this.grid_point_marker_icon_default}if(this.grid_point_marker_label_default){let marker_label=this.grid_point_marker_label_default;marker_label.text=evt.grid_point.data_keys.length.toString();marker_opts.label=marker_label;marker_opts.title=marker_label.text}return new google.maps.Marker(marker_opts)}grid_point_marker_update_default(evt){if(this.grid_point_marker_label_default){if(evt.grid_point.marker instanceof google.maps.Marker){let marker_label=this.grid_point_marker_label_default;marker_label.text=evt.grid_point.data_keys.length.toString();evt.grid_point.marker.setLabel(marker_label);evt.grid_point.marker.setTitle(marker_label.text)}}}latlon_bounds_to_pixel_bounds(bounds,zoom_level){let ne_wc=this.latlon_to_world_coord(bounds.getNorthEast());let scale=1<<zoom_level;let x=ne_wc.x*scale;let y=ne_wc.y*scale;let ne_pt=new google.maps.Point(x,y);let sw_wc=this.latlon_to_world_coord(bounds.getSouthWest());x=sw_wc.x*scale;y=sw_wc.y*scale;let sw_pt=new google.maps.Point(x,y);return{ne:ne_pt,sw:sw_pt}}latlon_to_pixel_coord(latlon,zoom_level){let world_coord=this.latlon_to_world_coord(latlon);return this.world_coord_to_pixel_coord(world_coord,zoom_level)}latlon_to_tile_coord(latlon,zoom_level){let world_coord=this.latlon_to_world_coord(latlon);let scale=1<<zoom_level;let x=Math.floor(world_coord.x*scale/this.tile_size.width);let y=Math.floor(world_coord.y*scale/this.tile_size.height);return new google.maps.Point(x,y)}latlon_to_world_coord(latlon){let x=this.k_google_map_tile_size*(.5+latlon.lng()/360);let siny=Math.sin(latlon.lat()*this.k_degrees_to_radians);let y=this.k_google_map_tile_size*(.5-Math.log((1+siny)/(1-siny))/this.k_4_pi);return new google.maps.Point(x,y)}limit_val(n,n_min,n_max){return Math.min(Math.max(n,n_min),n_max)}pixel_coord_to_latlon(pixel_coord,zoom_level){let world_coord=this.pixel_coord_to_world_coord(pixel_coord,zoom_level);return this.world_coord_to_latlon(world_coord)}pixel_coord_to_world_coord(pixel_coord,zoom_level){let scale=1<<zoom_level;let x=pixel_coord.x/scale;let y=pixel_coord.y/scale;return new google.maps.Point(x,y)}string_empty(s){if(typeof s=="string"){if(s.trim().length>0)return false}return true}tile_cluster_marker_delete(tile){if(tile){if(tile.marker){google.maps.event.clearInstanceListeners(tile.marker);if(tile.marker instanceof google.maps.Marker){tile.marker.setMap(null)}else if(tile.marker instanceof google.maps.marker.AdvancedMarkerView){tile.marker.map=null}tile.marker=null}}}tile_coord_lookup(tile_coord){if(tile_coord){for(let tile of this.tiles.values()){if(tile.coord.equals(tile_coord))return tile}}return null}tile_coord_min_max_update(){if(!this.map)return 0;let map_bounds=this.map.getBounds();if(!map_bounds){return 0}let map_zoom_level=this.map.getZoom();let map_ne=map_bounds.getNorthEast();let map_sw=map_bounds.getSouthWest();let map_nw=new google.maps.LatLng(map_ne.lat(),map_sw.lng());this.tile_coord_min=this.latlon_to_tile_coord(map_nw,map_zoom_level);let map_se=new google.maps.LatLng(map_sw.lat(),map_ne.lng());this.tile_coord_max=this.latlon_to_tile_coord(map_se,map_zoom_level);let tiles_per_row=this.tile_coord_max.x-this.tile_coord_min.x+1;return tiles_per_row}tile_coord_to_latlon_bounds(tile_coord,zoom_level){let scale=1<<zoom_level;let dx=this.tile_size.width/scale;let dy=this.tile_size.height/scale;let ne_wc=new google.maps.Point(tile_coord.x*dx+dx,tile_coord.y*dy);let sw_wc=new google.maps.Point(tile_coord.x*dx,tile_coord.y*dy+dy);let ne=this.world_coord_to_latlon(ne_wc);let sw=this.world_coord_to_latlon(sw_wc);return new google.maps.LatLngBounds(sw,ne)}tile_delete(tile){if(tile){this.tile_cluster_marker_delete(tile);this.tile_grid_points_delete_all(tile);tile.data_keys.length=0;tile=null}}tile_grid_points_delete_all(tile){if(tile){if(tile.grid_points){for(let grid_pt of tile.grid_points.values()){this.grid_point_delete(grid_pt)}tile.grid_points.clear();tile.grid_points=null}}}tile_grid_points_update(tile){let col;let grid_point_idx;let grid_point_idx_max;let i;let row;let tile_data_keys_count;let data_key;let grid_pt;let tile_pixel_bounds;let data_latlon;let grid_point_bounds;let ne_latlon;let sw_latlon;let pixel_coord;let marker_create_evt;let marker_update_evt;if(tile.grid_points){for(grid_pt of tile.grid_points.values()){grid_pt.data_keys.length=0}}else{tile.grid_points=new Map}tile_pixel_bounds=this.latlon_bounds_to_pixel_bounds(tile.bounds,tile.zoom);grid_point_idx_max=this.grid_point_rows*this.grid_point_cols-1;tile_data_keys_count=tile.data_keys.length;for(i=0;i<tile_data_keys_count;i++){data_key=tile.data_keys[i];data_latlon=this.data_points_map.get(data_key);pixel_coord=this.latlon_to_pixel_coord(data_latlon,tile.zoom);col=Math.floor((pixel_coord.x-tile_pixel_bounds.sw.x)/this.grid_box_width);row=Math.floor((pixel_coord.y-tile_pixel_bounds.ne.y)/this.grid_box_height);grid_point_idx=row*this.grid_point_cols+col;if(grid_point_idx>grid_point_idx_max){grid_point_idx=grid_point_idx_max}else{if(grid_point_idx<0){grid_point_idx=0}}grid_pt=tile.grid_points.get(grid_point_idx);if(!grid_pt){pixel_coord.x=tile_pixel_bounds.sw.x+col*this.grid_box_width+this.grid_box_width;pixel_coord.y=tile_pixel_bounds.ne.y+row*this.grid_box_height;ne_latlon=this.pixel_coord_to_latlon(pixel_coord,tile.zoom);pixel_coord.x=tile_pixel_bounds.sw.x+col*this.grid_box_width;pixel_coord.y=tile_pixel_bounds.ne.y+row*this.grid_box_height+this.grid_box_height;sw_latlon=this.pixel_coord_to_latlon(pixel_coord,tile.zoom);grid_point_bounds=new google.maps.LatLngBounds(sw_latlon,ne_latlon);grid_pt={idx:grid_point_idx,tile:tile,bounds:grid_point_bounds,marker:null,data_keys:new Array};tile.grid_points.set(grid_point_idx,grid_pt)}grid_pt.data_keys.push(data_key)}for([grid_point_idx,grid_pt]of tile.grid_points){if(grid_pt.data_keys.length==0){this.grid_point_delete(grid_pt);tile.grid_points.delete(grid_point_idx)}}for(grid_pt of tile.grid_points.values()){if(grid_pt.marker){if(this.grid_point_marker_update_handler){marker_update_evt={grid_point:grid_pt};this.grid_point_marker_update_handler(marker_update_evt)}}else{if(this.grid_point_marker_create_handler){marker_create_evt={grid_point:grid_pt};grid_pt.marker=this.grid_point_marker_create_handler(marker_create_evt);if(grid_pt.marker){this.grid_point_marker_click_handler_add(grid_pt);if(grid_pt.marker instanceof google.maps.Marker){grid_pt.marker.setMap(this.map)}else if(grid_pt.marker instanceof google.maps.marker.AdvancedMarkerView){grid_pt.marker.map=this.map}}}}}}tile_index_to_coord(tile_idx){let col;let row;let tile_idx_max;let tile_cols;let tile_rows;if(tile_idx>=0){if(this.tile_coord_min&&this.tile_coord_max){tile_cols=this.tile_coord_max.x-this.tile_coord_min.x+1;tile_rows=this.tile_coord_max.y-this.tile_coord_min.y+1;tile_idx_max=tile_cols*tile_rows;if(tile_idx<tile_idx_max){row=Math.floor(tile_idx/tile_cols);col=tile_idx%tile_cols;return new google.maps.Point(this.tile_coord_min.x+col,this.tile_coord_min.y+row)}}}return null}tile_overlay_create(){if(this.tile_overlay){this.tile_overlay_remove()}if(this.map){this.tile_overlay=new map_tile_overlay(this.tile_size);this.tile_overlay.border_color=this.tile_border_color;this.tile_overlay.border_style=this.tile_border_style;this.tile_overlay.border_width=this.tile_border_width;this.map.overlayMapTypes.insertAt(0,this.tile_overlay)}}tile_overlay_remove(){let idx;let no_of_overlays;if(this.tile_overlay){no_of_overlays=this.map.overlayMapTypes.getLength();for(idx=0;idx<no_of_overlays;idx++){if(this.map.overlayMapTypes.getAt(idx)===this.tile_overlay){this.map.overlayMapTypes.removeAt(idx);break}}this.tile_overlay=null}}world_coord_to_latlon(world_coord){let lon=(world_coord.x-this.k_pixel_origin.x)/this.k_pixels_per_lon_degree;let lat_radians=(world_coord.y-this.k_pixel_origin.y)/-this.k_pixels_per_lon_radian;let lat=(2*Math.atan(Math.exp(lat_radians))-this.k_half_pi)/this.k_degrees_to_radians;return new google.maps.LatLng(lat,lon)}world_coord_to_pixel_coord(world_coord,zoom_level){let scale=1<<zoom_level;let x=Math.floor(world_coord.x*scale);let y=Math.floor(world_coord.y*scale);return new google.maps.Point(x,y)}auto_redraw_event_add(event_name){if(this.map){if(!this.string_empty(event_name)){if(!this.auto_redraw_map.has(event_name)){let listener=google.maps.event.addListener(this.map,event_name,(()=>{this.redraw()}));this.auto_redraw_map.set(event_name,listener)}}}}auto_redraw_event_remove(event_name){if(this.auto_redraw_map.has(event_name)){let listener=this.auto_redraw_map.get(event_name);listener.remove();return this.auto_redraw_map.delete(event_name)}return false}auto_redraw_events(){return[...this.auto_redraw_map.keys()]}auto_redraw_events_clear(){if(this.auto_redraw_map.size>0){for(let listener of this.auto_redraw_map.values()){listener.remove()}this.auto_redraw_map.clear()}}get auto_redraw_events_count(){return this.auto_redraw_map.size}clear(){this.tile_overlay_remove();this.auto_redraw_events_clear();this.tiles_clear();this.data_points_clear()}cluster_marker_click_handler_use_default(){this.cluster_marker_click_handler=this.cluster_marker_click_handler_default}cluster_marker_create_use_default(){this.cluster_marker_create_handler=this.cluster_marker_create_default}cluster_marker_update_use_default(){this.cluster_marker_update_handler=this.cluster_marker_update_default}configure(opts){let n;let replace_tile_overlay=false;let need_to_redraw_tiles=false;if(opts){if(opts.hasOwnProperty("cluster_marker_click_event_name")){if(this.cluster_marker_click_event_name!=opts.cluster_marker_click_event_name){this.cluster_marker_click_event_name=opts.cluster_marker_click_event_name;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_marker_click_event_name")){if(this.grid_point_marker_click_event_name!=opts.grid_point_marker_click_event_name){this.grid_point_marker_click_event_name=opts.grid_point_marker_click_event_name;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("tiles_redraw_start_event_name")){if(this.tiles_redraw_start_event_name!=opts.tiles_redraw_start_event_name){this.tiles_redraw_start_event_name=opts.tiles_redraw_start_event_name;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("tiles_redraw_end_event_name")){if(this.tiles_redraw_end_event_name!=opts.tiles_redraw_end_event_name){this.tiles_redraw_end_event_name=opts.tiles_redraw_end_event_name;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("tile_size")){let height=this.limit_val(opts.tile_size.height,this.k_tile_height_min,this.k_tile_height_max);let width=this.limit_val(opts.tile_size.width,this.k_tile_width_min,this.k_tile_width_max);if(this.tile_size.height!=height||this.tile_size.width!=width){this.tile_size.height=Math.floor(height);this.tile_size.width=Math.floor(width);replace_tile_overlay=true;need_to_redraw_tiles=true}}let grid_cols_max=Math.floor(this.tile_size.width/this.k_grid_box_width_max);let grid_rows_max=Math.floor(this.tile_size.height/this.k_grid_box_height_max);if(opts.hasOwnProperty("grid_point_cols")){n=this.limit_val(opts.grid_point_cols,1,grid_cols_max);if(this.grid_point_cols!=n){this.grid_point_cols=n;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_rows")){n=this.limit_val(opts.grid_point_rows,1,grid_rows_max);if(this.grid_point_rows!=n){this.grid_point_rows=n;need_to_redraw_tiles=true}}this.grid_box_height=this.tile_size.height/this.grid_point_rows;this.grid_box_width=this.tile_size.width/this.grid_point_cols;if(opts.hasOwnProperty("cluster_size_min")){if(opts.cluster_size_min>=this.k_cluster_size_min){if(this.cluster_size_min!=opts.cluster_size_min){this.cluster_size_min=opts.cluster_size_min;need_to_redraw_tiles=true}}}if(opts.hasOwnProperty("cluster_zoom_max")){if(opts.cluster_zoom_max>0){if(this.cluster_zoom_max!=opts.cluster_zoom_max){this.cluster_zoom_max=opts.cluster_zoom_max;need_to_redraw_tiles=true}}}if(opts.hasOwnProperty("cluster_marker_click_check")){if(this.cluster_marker_click_check!=opts.cluster_marker_click_check){this.cluster_marker_click_check=opts.cluster_marker_click_check;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("cluster_marker_click_handler")){if(this.cluster_marker_click_handler!==opts.cluster_marker_click_handler){this.cluster_marker_click_handler=opts.cluster_marker_click_handler;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("cluster_marker_create_handler")){if(this.cluster_marker_create_handler!==opts.cluster_marker_create_handler){this.cluster_marker_create_handler=opts.cluster_marker_create_handler;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("cluster_marker_update_handler")){if(this.cluster_marker_update_handler!==opts.cluster_marker_update_handler){this.cluster_marker_update_handler=opts.cluster_marker_update_handler;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("cluster_marker_icon_default")){if(this.cluster_marker_icon_default!==opts.cluster_marker_icon_default){this.cluster_marker_icon_default=opts.cluster_marker_icon_default;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("cluster_marker_label_default")){if(this.cluster_marker_label_default!==opts.cluster_marker_label_default){this.cluster_marker_label_default=opts.cluster_marker_label_default;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_marker_click_handler")){if(this.grid_point_marker_click_handler!==opts.grid_point_marker_click_handler){this.grid_point_marker_click_handler=opts.grid_point_marker_click_handler;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_marker_create_handler")){if(this.grid_point_marker_create_handler!==opts.grid_point_marker_create_handler){this.grid_point_marker_create_handler=opts.grid_point_marker_create_handler;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_marker_update_handler")){if(this.grid_point_marker_update_handler!==opts.grid_point_marker_update_handler){this.grid_point_marker_update_handler=opts.grid_point_marker_update_handler;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_marker_icon_default")){if(this.grid_point_marker_icon_default!==opts.grid_point_marker_icon_default){this.grid_point_marker_icon_default=opts.grid_point_marker_icon_default;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("grid_point_marker_label_default")){if(this.grid_point_marker_label_default!==opts.grid_point_marker_label_default){this.grid_point_marker_label_default=opts.grid_point_marker_label_default;need_to_redraw_tiles=true}}if(opts.hasOwnProperty("tile_border_color")){if(!this.string_empty(opts.tile_border_color)){if(this.tile_border_color!=opts.tile_border_color){this.tile_border_color=opts.tile_border_color;replace_tile_overlay=true}}}if(opts.hasOwnProperty("tile_border_style")){if(!this.string_empty(opts.tile_border_style)){if(this.tile_border_style!=opts.tile_border_style){this.tile_border_style=opts.tile_border_style;replace_tile_overlay=true}}}if(opts.hasOwnProperty("tile_border_width")){if(!this.string_empty(opts.tile_border_width)){if(this.tile_border_width!=opts.tile_border_width){this.tile_border_width=opts.tile_border_width;replace_tile_overlay=true}}}if(replace_tile_overlay){if(this.tile_borders_visible){this.tile_overlay_remove()}}if(opts.hasOwnProperty("tile_borders_visible")){this.tile_borders_visible=opts.tile_borders_visible}}else{this.configure_use_defaults();replace_tile_overlay=true;need_to_redraw_tiles=true}if(need_to_redraw_tiles){this.tiles_clear();this.redraw()}}data_point_delete(key){return this.data_points_map.delete(key)}data_point_exists(key){return this.data_points_map.has(key)}data_point_latlon(key){return this.data_points_map.get(key)}data_point_upsert(data_pt){if(data_pt.lat<this.k_lat_min||data_pt.lat>this.k_lat_max||data_pt.lon<this.k_lon_min||data_pt.lon>this.k_lon_max)return false;this.data_points_map.set(data_pt.key,new google.maps.LatLng(data_pt.lat,data_pt.lon));return true}data_points_clear(){this.data_points_map.clear()}get data_points_count(){return this.data_points_map.size}data_points_upsert(data_points){if(data_points){if(data_points.length){for(let i=0;i<data_points.length;i++){this.data_point_upsert(data_points[i])}}}}grid_point(tile_idx,grid_point_idx){let tile=this.tile(tile_idx);if(tile){if(tile.grid_points){let grid_pt=tile.grid_points.get(grid_point_idx);if(grid_pt)return grid_pt}}return null}grid_point_bounds(tile_idx,grid_point_idx){let col;let idx_max;let map_zoom_level;let row;let ne_latlon;let sw_latlon;let tile_bounds;let pixel_coord;let tile_pixel_bounds;if(!this.map)return null;idx_max=this.grid_point_rows*this.grid_point_cols-1;if(grid_point_idx<0)return null;if(grid_point_idx>idx_max)return null;tile_bounds=this.tile_bounds(tile_idx);if(!tile_bounds)return null;row=Math.floor(grid_point_idx/this.grid_point_cols);col=grid_point_idx%this.grid_point_cols;map_zoom_level=this.map.getZoom();tile_pixel_bounds=this.latlon_bounds_to_pixel_bounds(tile_bounds,map_zoom_level);pixel_coord=new google.maps.Point(0,0);pixel_coord.x=tile_pixel_bounds.sw.x+col*this.grid_box_width+this.grid_box_width;pixel_coord.y=tile_pixel_bounds.ne.y+row*this.grid_box_height;ne_latlon=this.pixel_coord_to_latlon(pixel_coord,map_zoom_level);pixel_coord.x=tile_pixel_bounds.sw.x+col*this.grid_box_width;pixel_coord.y=tile_pixel_bounds.ne.y+row*this.grid_box_height+this.grid_box_height;sw_latlon=this.pixel_coord_to_latlon(pixel_coord,map_zoom_level);return new google.maps.LatLngBounds(sw_latlon,ne_latlon)}grid_point_marker_create_use_default(){this.grid_point_marker_create_handler=this.grid_point_marker_create_default}grid_point_marker_update_use_default(){this.grid_point_marker_update_handler=this.grid_point_marker_update_default}latlon_to_tile_index(latlon){if(this.map){let map_bounds=this.map.getBounds();if(map_bounds){if(map_bounds.contains(latlon)){let tiles_per_row=this.tile_coord_min_max_update();if(tiles_per_row>0){let map_zoom_level=this.map.getZoom();let tile_coord=this.latlon_to_tile_coord(latlon,map_zoom_level);let tile_idx=(tile_coord.y-this.tile_coord_min.y)*tiles_per_row+tile_coord.x-this.tile_coord_min.x;return tile_idx}}}}return-1}redraw(){let data_keys_count;let map_zoom_level;let tiles_per_row;let tile_coord_key;let map_bounds;let tile_bounds;let tile_coord;let marker_create_evt;let marker_update_evt;let tile;if(!this.map)return;map_bounds=this.expand_map_bounds_by_tile_size();if(!map_bounds){return}if(!this.string_empty(this.tiles_redraw_start_event_name)){google.maps.event.trigger(this.map,this.tiles_redraw_start_event_name)}map_zoom_level=this.map.getZoom();tiles_per_row=this.tile_coord_min_max_update();for([tile_coord_key,tile]of this.tiles){tile.data_bounds=new google.maps.LatLngBounds;tile.data_keys.length=0;if(tile.zoom!=map_zoom_level){this.tile_delete(tile);this.tiles.delete(tile_coord_key)}}for(let[data_key,data_latlon]of this.data_points_map){if(map_bounds.contains(data_latlon)){tile_coord=this.latlon_to_tile_coord(data_latlon,map_zoom_level);tile_coord_key=tile_coord.x.toString()+tile_coord.y.toString();tile=this.tiles.get(tile_coord_key);if(!tile){tile_bounds=this.tile_coord_to_latlon_bounds(tile_coord,map_zoom_level);tile={idx:0,coord:tile_coord,bounds:tile_bounds,marker:null,data_bounds:new google.maps.LatLngBounds,data_keys:new Array,grid_points:null,zoom:map_zoom_level};this.tiles.set(tile_coord_key,tile)}tile.data_keys.push(data_key);tile.data_bounds.extend(data_latlon)}}for([tile_coord_key,tile]of this.tiles){if(tile.data_keys.length==0){this.tile_delete(tile);this.tiles.delete(tile_coord_key)}}for(tile of this.tiles.values()){tile.idx=(tile.coord.y-this.tile_coord_min.y)*tiles_per_row+tile.coord.x-this.tile_coord_min.x;data_keys_count=tile.data_keys.length;if(map_zoom_level<=this.cluster_zoom_max&&data_keys_count>=this.cluster_size_min){this.tile_grid_points_delete_all(tile);if(tile.marker){if(this.cluster_marker_update_handler){marker_update_evt={tile:tile};this.cluster_marker_update_handler(marker_update_evt)}}else{if(this.cluster_marker_create_handler){marker_create_evt={tile:tile};tile.marker=this.cluster_marker_create_handler(marker_create_evt);if(tile.marker){this.cluster_marker_click_handler_add(tile);if(tile.marker instanceof google.maps.Marker){tile.marker.setMap(this.map)}else if(tile.marker instanceof google.maps.marker.AdvancedMarkerView){tile.marker.map=this.map}}}}}else{this.tile_cluster_marker_delete(tile);this.tile_grid_points_update(tile)}}if(!this.string_empty(this.tiles_redraw_end_event_name)){google.maps.event.trigger(this.map,this.tiles_redraw_end_event_name)}}tile(tile_idx){for(let tile of this.tiles.values()){if(tile.idx==tile_idx)return tile}return null}get tile_borders_visible(){if(this.tile_overlay){return true}return false}set tile_borders_visible(show_tile_borders){if(show_tile_borders){this.tile_overlay_create()}else{this.tile_overlay_remove()}}tile_bounds(tile_idx){let tile_coord=this.tile_index_to_coord(tile_idx);if(tile_coord){return this.tile_coord_to_latlon_bounds(tile_coord,this.map.getZoom())}return null}get tile_count(){return this.tiles.size}get tile_grid_point_cols(){return this.grid_point_cols}get tile_grid_point_index_max(){return this.grid_point_rows*this.grid_point_cols-1}get tile_grid_point_rows(){return this.grid_point_rows}get tile_height(){return this.tile_size.height}get tile_index_max(){let tile_idx_max=-1;let tile_cols=this.tile_coord_min_max_update();if(tile_cols>0){let tile_rows=this.tile_coord_max.y-this.tile_coord_min.y+1;tile_idx_max=tile_rows*tile_cols-1}return tile_idx_max}tiles_clear(){for(let tile of this.tiles.values()){this.tile_delete(tile)}this.tiles.clear()}get tile_width(){return this.tile_size.width}}